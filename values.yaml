## Rocket.Chat Helm values (parity-first)
## Chart: rocketchat/rocketchat 6.27.1
## Goal: match current runtime behavior while moving to Helm+values GitOps.

image:
  repository: registry.rocket.chat/rocketchat/rocket.chat
  # Pin to the currently running version for the migration. Upgrade later by changing ONLY this value.
  tag: "7.13.2"
  pullPolicy: IfNotPresent

# Host for Rocket.Chat (used to set ROOT_URL and for ingress)
host: k8.canepro.me

replicaCount: 1
minAvailable: 1

# Reuse the existing Secret that already contains:
# - mongo-uri
# - mongo-oplog-uri
# - mail-url
# existingMongodbSecret: rocketchat-rocketchat

# Provide explicit URLs because the chart overwrote the secret with empty values.
# This forces the chart to regenerate the secret with the correct connection strings.
externalMongodbUrl: "mongodb://root:rocketchatroot@rocketchat-mongodb-0.rocketchat-mongodb-headless.rocketchat.svc.cluster.local:27017/rocketchat?authSource=admin&replicaSet=rs0"
externalMongodbOplogUrl: "mongodb://root:rocketchatroot@rocketchat-mongodb-0.rocketchat-mongodb-headless.rocketchat.svc.cluster.local:27017/local?authSource=admin&replicaSet=rs0"

smtp:
  enabled: true
  # Provide credentials so the chart generates the mail-url in the managed secret.
  # Using the recovered password from smtp-credentials.
  username: postmaster@canepro.me
  password: "Genimi123456"
  host: smtp.mailgun.org
  port: 587


# Enable standard metrics so RocketChat exposes /metrics
metrics:
  enabled: true
  # We manage the ServiceMonitor manually in ops/manifests
  serviceMonitor:
    enabled: false

# Deprecated/Custom field - removing effectively (commented out)
# prometheusScraping:
#   enabled: true
#   port: 9100
#   msPort: 9458

# We manage monitoring objects (ServiceMonitors/CRDs) via the ops ArgoCD app.
# Disable chart-generated monitors to avoid shared-resource conflicts.
serviceMonitor:
  enabled: false
podMonitor:
  enabled: false

microservices:
  enabled: true
  logLevel: warn
  heartbeatInterval: 10
  heartbeatTimeout: 30
  # Keep defaults for image repos; tag is controlled globally via image.tag above
  account:
    replicas: 1
  authorization:
    replicas: 1
  presence:
    replicas: 1
  ddpStreamer:
    replicas: 1
  streamHub:
    replicas: 1

# IMPORTANT: do NOT deploy bundled MongoDB or NATS.
# We keep your existing rocketchat-mongodb and rocketchat-nats resources.
mongodb:
  enabled: false
  # Explicitly disable the serviceMonitor for mongodb, as the chart might still try to render it.
  serviceMonitor:
    enabled: false
  metrics:
    enabled: false
    serviceMonitor:
      enabled: false

# With microservices enabled, the chart normally deploys NATS unless explicitly disabled.
# Disable it and source the TRANSPORTER connection string from a small non-sensitive Secret
# (so all microservices get the same TRANSPORTER via chart templating).
nats:
  enabled: false
  existingSecret:
    name: rocketchat-nats-connection
    key: connectionString

# Keep Rocket.Chat uploads PVC managed by the chart (so it is not treated as an extraneous resource).
# Match the current PVC characteristics (2Gi, RWO, local-path).
persistence:
  enabled: true
  accessMode: ReadWriteOnce
  size: 2Gi
  # Match the existing PVC's storageClassName to avoid immutable diffs.
  storageClass: local-path

ingress:
  enabled: true
  ingressClassName: traefik
  annotations:
    cert-manager.io/cluster-issuer: production-cert-issuer
  path: /
  pathType: Prefix
  tls:
    - secretName: rocketchat-tls
      hosts:
        - k8.canepro.me

# Keep existing SMTP override settings from your current Deployment (non-sensitive)
extraEnv:
  - name: OVERWRITE_SETTING_SMTP_Host
    value: "smtp.mailgun.org"
  - name: OVERWRITE_SETTING_SMTP_Username
    value: "postmaster@canepro.me"

