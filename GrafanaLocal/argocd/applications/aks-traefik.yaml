# ArgoCD Application: Traefik Ingress Controller
# This ArgoCD Application deploys Traefik as the ingress controller for the AKS cluster.
# Traefik handles HTTP/HTTPS routing and TLS termination for all ingress resources.
# See VERSIONS.md for version tracking. Current: Traefik Helm chart 34.4.1
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: aks-traefik
  namespace: argocd
  labels:
    app: traefik  # Application identifier in ArgoCD
    cluster: aks-canepro  # Cluster identifier for filtering in ArgoCD
spec:
  project: default  # ArgoCD project (controls permissions and allowed resources)
  sources:
    # Helm chart source: Official Traefik Helm chart repository
    # Traefik Helm chart
    - repoURL: https://traefik.github.io/charts  # Traefik Helm chart repository
      chart: traefik  # Chart name
      targetRevision: 34.4.1  # Chart version - See VERSIONS.md for latest version and upgrade status
      helm:
        releaseName: traefik  # Helm release name (used for resource naming)
        # Values override default chart values and configure Traefik for this environment
        valueFiles:
          - $values/traefik-values.yaml  # Reference to traefik-values.yaml from Git source below
    # Values source: Traefik configuration from Git repository
    # Values from Git repository
    - ref: values  # Reference name (used by $values in valueFiles above)
      repoURL: https://github.com/Canepro/rocketchat-k8s.git  # Git repository URL
      targetRevision: aks-migration  # Branch/tag containing traefik-values.yaml (change to 'main' after merge)
  destination:
    server: https://aks-canepro-wfcra91z.hcp.uksouth.azmk8s.io:443  # AKS cluster API server
    namespace: traefik  # Target namespace for Traefik deployment
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
      - PrunePropagationPolicy=foreground
    retry:
      limit: 5
      backoff:
        duration: 5s
        factor: 2
        maxDuration: 3m
