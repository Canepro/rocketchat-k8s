agent:
  mode: flow
  configMap:
    create: true
    content: |
      // Metrics: Scrape RocketChat Pods
      discovery.kubernetes "pods" {
        role = "pod"
      }

      discovery.relabel "rocketchat" {
        targets = discovery.kubernetes.pods.targets
        rule {
          // Scrape pods with name starting with rocketchat (covers main app and microservices)
          source_labels = ["__meta_kubernetes_pod_label_app_kubernetes_io_name"]
          regex = "rocketchat.*"
          action = "keep"
        }
      }

      prometheus.scrape "rocketchat" {
        targets = discovery.relabel.rocketchat.output
        forward_to = [prometheus.remote_write.central.receiver]
      }

      prometheus.remote_write "central" {
        endpoint {
          url = "https://observability.canepro.me/prometheus/api/v1/write"
          basic_auth {
            username = "observability-user"
            password = "YOUR_PASSWORD_HERE"
          }
        }
      }

      // Logs: Collect Cluster Logs
      discovery.relabel "logs" {
        targets = discovery.kubernetes.pods.targets
        rule {
          source_labels = ["__meta_kubernetes_pod_label_app_kubernetes_io_name"]
          regex = "rocketchat.*"
          action = "keep"
        }
      }

      loki.source.kubernetes "rocketchat" {
        targets = discovery.relabel.logs.output
        forward_to = [loki.write.central.receiver]
      }

      loki.write "central" {
        endpoint {
          url = "https://observability.canepro.me/loki/loki/api/v1/push"
          tenant_id = "fake"
          basic_auth {
            username = "observability-user"
            password = "YOUR_PASSWORD_HERE"
          }
        }
      }

      // Traces: OTLP Receiver
      otelcol.receiver.otlp "default" {
        http { endpoint = "0.0.0.0:4318" }
        grpc { endpoint = "0.0.0.0:4317" }
        output {
          traces = [otelcol.exporter.otlphttp.central.input]
        }
      }

      otelcol.exporter.otlphttp "central" {
        client {
          endpoint = "https://observability.canepro.me/tempo"
          auth = otelcol.auth.basic.central.handler
        }
      }

      otelcol.auth.basic "central" {
        username = "observability-user"
        password = "YOUR_PASSWORD_HERE"
      }

controller:
  type: deployment
  replicas: 1

