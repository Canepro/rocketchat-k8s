# ExternalSecret: Rocket.Chat MongoDB Connection Strings
# This ExternalSecret syncs MongoDB connection strings from Azure Key Vault to a Kubernetes Secret.
# Rocket.Chat Helm chart reads this Secret and sets MONGO_URL and MONGO_OPLOG_URL environment variables.
# See VERSIONS.md for External Secrets Operator version tracking (managed by Helm chart via ArgoCD).
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: rocketchat-mongodb-external  # ExternalSecret name (also used as target Secret name)
  namespace: rocketchat  # Namespace for Rocket.Chat deployment
spec:
  refreshInterval: 1h  # How often to sync from Key Vault (1 hour)
  secretStoreRef:
    # Reference to ClusterSecretStore (see clustersecretstore-azure-keyvault.yaml)
    name: azure-keyvault  # ClusterSecretStore name (from ops/secrets/clustersecretstore-azure-keyvault.yaml)
    kind: ClusterSecretStore  # ClusterSecretStore kind (cluster-scoped secret store)
  target:
    name: rocketchat-mongodb-external  # Kubernetes Secret name (created by ESO, referenced in values.yaml)
    creationPolicy: Owner  # ESO owns the Secret (can delete/modify it)
    template:
      type: Opaque  # Secret type (allows arbitrary key-value pairs)
  data:
    # Secret keys to sync from Key Vault
    - secretKey: mongo-uri  # Kubernetes Secret key name (Rocket.Chat Helm chart reads this as MONGO_URL)
      remoteRef:
        # Azure Key Vault secret name (from terraform/keyvault.tf)
        # AKV secret name
        key: rocketchat-mongo-uri  # Key Vault secret name (created by Terraform)
    - secretKey: mongo-oplog-uri  # Kubernetes Secret key name (Rocket.Chat Helm chart reads this as MONGO_OPLOG_URL)
      remoteRef:
        # Azure Key Vault secret name (from terraform/keyvault.tf)
        # AKV secret name
        key: rocketchat-mongo-oplog-uri  # Key Vault secret name (created by Terraform)

