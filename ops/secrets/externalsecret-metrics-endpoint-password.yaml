# ExternalSecret: MongoDB Metrics Endpoint Password
# This ExternalSecret syncs the MongoDB metrics endpoint password from Azure Key Vault to a Kubernetes Secret.
# MongoDB Community Operator uses this Secret for MongoDB metrics endpoint authentication.
# See VERSIONS.md for External Secrets Operator version tracking (managed by Helm chart via ArgoCD).
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: metrics-endpoint-password  # ExternalSecret name (also used as target Secret name)
  namespace: rocketchat  # Namespace for MongoDB deployment
spec:
  refreshInterval: 1h  # How often to sync from Key Vault (1 hour)
  secretStoreRef:
    # Reference to ClusterSecretStore (see clustersecretstore-azure-keyvault.yaml)
    name: azure-keyvault  # ClusterSecretStore name (from ops/secrets/clustersecretstore-azure-keyvault.yaml)
    kind: ClusterSecretStore  # ClusterSecretStore kind (cluster-scoped secret store)
  target:
    name: metrics-endpoint-password  # Kubernetes Secret name (created by ESO)
    creationPolicy: Owner  # ESO owns the Secret (can delete/modify it)
    template:
      type: Opaque  # Secret type (allows arbitrary key-value pairs)
  data:
    # Secret keys to sync from Key Vault
    - secretKey: password  # Kubernetes Secret key name (MongoDB operator reads this key for metrics auth)
      remoteRef:
        # Azure Key Vault secret name (from terraform/keyvault.tf)
        key: rocketchat-mongodb-metrics-endpoint-password  # Key Vault secret name (created by Terraform)

