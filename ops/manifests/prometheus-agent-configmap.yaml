# Prometheus Agent Configuration
# This ConfigMap contains the Prometheus Agent configuration.
# Credentials are provided via files mounted from the existing Secret (observability-credentials).
# See VERSIONS.md for version tracking.
apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-agent-config
  namespace: monitoring
data:
  prometheus.yml: |
    global:
      scrape_interval: 30s  # How often to scrape metrics from targets
      external_labels:
        # External labels: Added to all metrics sent to remote_write endpoint
        # These labels help identify metrics in Grafana/Mimir (filter by cluster, tenant_id, etc.)
        # AKS Migration: Updated cluster label for AKS cluster
        cluster: aks-canepro  # Cluster identifier (filter by this in Grafana)
        # Some Grafana dashboards (for example StarsL dashboards) filter on `origin_prometheus`.
        # Set this explicitly so multi-cluster dashboards can switch between OKE hub and AKS spoke data.
        origin_prometheus: aks-canepro
        # Compatibility with existing Grafana Rocket.Chat dashboards (they filter by tenant_id)
        tenant_id: aks-canepro  # Tenant identifier (for dashboard compatibility)
        environment: production  # Environment label
        workspace: production  # Workspace label
        domain: k8.canepro.me  # Domain this cluster serves
    
    # Remote write configuration: Where to send scraped metrics
    remote_write:
      - url: https://observability.canepro.me/api/v1/write
        basic_auth:
          username_file: /etc/observability-auth/username
          password_file: /etc/observability-auth/password
        headers:
          X-Scope-OrgID: "1"
        queue_config:
          capacity: 5000
          max_shards: 50
          min_shards: 1
          max_samples_per_send: 2000
          batch_send_deadline: 5s
          min_backoff: 100ms
          max_backoff: 1s

    scrape_configs:
      # Scrape Kubernetes pods with prometheus.io annotations
      - job_name: 'kubernetes-pods'
        kubernetes_sd_configs:
          - role: pod
        relabel_configs:
          - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
            action: keep
            regex: true
          - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]
            action: replace
            target_label: __metrics_path__
          - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]
            action: replace
            regex: ([^:]+)(?::\d+)?;(\d+)
            replacement: $1:$2
            target_label: __address__
          - action: labelmap
            regex: __meta_kubernetes_pod_label_(.+)
          - source_labels: [__meta_kubernetes_namespace]
            action: replace
            target_label: kubernetes_namespace
          - source_labels: [__meta_kubernetes_pod_name]
            action: replace
            target_label: kubernetes_pod_name
        # Compatibility label for dashboards expecting `namespace` instead of `kubernetes_namespace`
        metric_relabel_configs:
          - source_labels: [kubernetes_namespace]
            target_label: namespace
            action: replace

      # Scrape Kubernetes services
      - job_name: 'kubernetes-services'
        kubernetes_sd_configs:
          - role: service
        relabel_configs:
          - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scrape]
            action: keep
            regex: true
          - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_path]
            action: replace
            target_label: __metrics_path__
          - source_labels: [__address__, __meta_kubernetes_service_annotation_prometheus_io_port]
            action: replace
            regex: ([^:]+)(?::\d+)?;(\d+)
            replacement: $1:$2
            target_label: __address__
          - action: labelmap
            regex: __meta_kubernetes_service_label_(.+)
          - source_labels: [__meta_kubernetes_namespace]
            action: replace
            target_label: kubernetes_namespace
          - source_labels: [__meta_kubernetes_service_name]
            action: replace
            target_label: kubernetes_service_name
        # Compatibility label for dashboards expecting `namespace` instead of `kubernetes_namespace`
        metric_relabel_configs:
          - source_labels: [kubernetes_namespace]
            target_label: namespace
            action: replace

      # Scrape CoreDNS metrics (AKS kube-system)
      # AKS CoreDNS pods expose Prometheus metrics on port 9153 named "metrics",
      # but are not annotated by default.
      - job_name: 'coredns'
        kubernetes_sd_configs:
          - role: pod
            namespaces:
              names: ['kube-system']
        relabel_configs:
          - source_labels: [__meta_kubernetes_pod_label_k8s_app]
            action: keep
            regex: kube-dns
          - source_labels: [__meta_kubernetes_pod_container_port_name]
            action: keep
            regex: metrics
          - source_labels: [__meta_kubernetes_pod_ip]
            action: replace
            target_label: __address__
            replacement: $1:9153
          - source_labels: [__meta_kubernetes_namespace]
            action: replace
            target_label: kubernetes_namespace
          - source_labels: [__meta_kubernetes_pod_name]
            action: replace
            target_label: kubernetes_pod_name
        metric_relabel_configs:
          - source_labels: [kubernetes_namespace]
            target_label: namespace
            action: replace

      # Scrape MongoDB Community Operator metrics (basic auth protected)
      # The metrics endpoint is exposed via the headless service `mongodb-svc` on port 9216.
      - job_name: 'mongodb-metrics'
        metrics_path: /metrics
        basic_auth:
          username: prometheus-username
          password_file: /etc/mongodb-metrics-auth/password
        kubernetes_sd_configs:
          - role: endpoints
            namespaces:
              names: ['rocketchat']
        relabel_configs:
          - source_labels: [__meta_kubernetes_endpoints_name]
            action: keep
            regex: mongodb-svc
          - source_labels: [__meta_kubernetes_endpoint_port_name]
            action: keep
            regex: prometheus
          - action: labelmap
            regex: __meta_kubernetes_service_label_(.+)
          - source_labels: [__meta_kubernetes_namespace]
            action: replace
            target_label: kubernetes_namespace
          - source_labels: [__meta_kubernetes_endpoints_name]
            action: replace
            target_label: kubernetes_service_name
        metric_relabel_configs:
          - source_labels: [kubernetes_namespace]
            target_label: namespace
            action: replace

      # Scrape Prometheus Agent self-metrics (for remote_write health monitoring)
      # This lets us verify remote_write success rates and queue health via Prometheus/Grafana
      - job_name: 'prometheus-agent'
        kubernetes_sd_configs:
          - role: pod
        relabel_configs:
          - source_labels: [__meta_kubernetes_namespace]
            action: keep
            regex: monitoring
          - source_labels: [__meta_kubernetes_pod_label_app]
            action: keep
            regex: prometheus-agent
          - source_labels: [__meta_kubernetes_pod_ip]
            action: replace
            target_label: __address__
            replacement: $1:9090
          - source_labels: [__meta_kubernetes_pod_name]
            action: replace
            target_label: kubernetes_pod_name
          - source_labels: [__meta_kubernetes_namespace]
            action: replace
            target_label: kubernetes_namespace

      # Scrape OTel Collector self-metrics (spoke cluster)
      # This lets us verify trace pipeline health (accepted/exported spans) via Prometheus/Grafana,
      # without requiring any manual debug pods.
      - job_name: 'otel-collector'
        kubernetes_sd_configs:
          - role: pod
        relabel_configs:
          - source_labels: [__meta_kubernetes_namespace]
            action: keep
            regex: monitoring
          - source_labels: [__meta_kubernetes_pod_label_app]
            action: keep
            regex: otel-collector
          - source_labels: [__meta_kubernetes_pod_ip]
            action: replace
            target_label: __address__
            replacement: $1:8888
          - action: labelmap
            regex: __meta_kubernetes_pod_label_(.+)
          - source_labels: [__meta_kubernetes_namespace]
            action: replace
            target_label: kubernetes_namespace
          - source_labels: [__meta_kubernetes_pod_name]
            action: replace
            target_label: kubernetes_pod_name

      # Scrape Kubernetes nodes
      - job_name: 'kubernetes-nodes'
        scheme: https
        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
        tls_config:
          insecure_skip_verify: true
        kubernetes_sd_configs:
          - role: node
        relabel_configs:
          - action: labelmap
            regex: __meta_kubernetes_node_label_(.+)
          - source_labels: [__meta_kubernetes_node_name]
            action: replace
            target_label: node
          - target_label: __address__
            replacement: kubernetes.default.svc:443
          - source_labels: [__meta_kubernetes_node_name]
            regex: (.+)
            target_label: __metrics_path__
            replacement: /api/v1/nodes/$1/proxy/metrics
