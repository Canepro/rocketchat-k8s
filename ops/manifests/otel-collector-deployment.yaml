# OpenTelemetry Collector Deployment
# The OTel Collector receives traces from applications (via OTLP/gRPC/HTTP) and forwards them to central Tempo.
# It can also receive Jaeger and Zipkin formatted traces (for compatibility).
# See VERSIONS.md for version tracking. Latest version: v0.142.0 (as of 2026-01-16)
apiVersion: apps/v1
kind: Deployment
metadata:
  name: otel-collector
  namespace: monitoring
  labels:
    app: otel-collector
spec:
  replicas: 1  # Single replica is sufficient (not stateful)
  selector:
    matchLabels:
      app: otel-collector
  template:
    metadata:
      labels:
        app: otel-collector
      annotations:
        # Config revision annotation: Update this when config changes to trigger pod restart
        canepro.me/otel-collector-config-rev: "2026-01-18-01"
    spec:
      containers:
        - name: otel-collector
          # OpenTelemetry Collector Contrib image version - See VERSIONS.md for latest version and update procedure
          # Current: v0.142.0 (latest stable as of 2026-01-16)
          # Note: v0.88.0 is outdated. Update to v0.142.0 or later.
          # "contrib" variant includes extra receivers/exporters beyond core collector
          image: otel/opentelemetry-collector-contrib:0.142.0
          imagePullPolicy: IfNotPresent
          command:
            # OTel Collector binary (contrib variant)
            - /otelcol-contrib
            # Config file location (from ConfigMap)
            - --config=/etc/otel-collector-config.yaml
          env:
            # Go memory limit: Prevents collector from using too much memory
            # Set to 512MiB to match resource limits below
            - name: GOMEMLIMIT
              value: 512MiB
            # Credentials for basic auth to central Tempo hub (from observability-credentials secret)
            # These are referenced in the ConfigMap as ${env:GRAFANA_USERNAME} and ${env:GRAFANA_PASSWORD}
            # Kept in Secret (not committed to Git) for security
            - name: GRAFANA_USERNAME
              valueFrom:
                secretKeyRef:
                  name: observability-credentials
                  key: username
            - name: GRAFANA_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: observability-credentials
                  key: password
          ports:
            - containerPort: 4317
              name: otlp-grpc
            - containerPort: 4318
              name: otlp-http
            - containerPort: 14250
              name: jaeger-grpc
            - containerPort: 14268
              name: jaeger-http
            - containerPort: 6831
              name: jaeger-compact
            - containerPort: 6832
              name: jaeger-binary
            - containerPort: 9411
              name: zipkin
            - containerPort: 8888
              name: prometheus
            - containerPort: 8889
              name: metrics
          livenessProbe:
            httpGet:
              path: /
              port: 13133
            initialDelaySeconds: 30
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /
              port: 13133
            initialDelaySeconds: 5
            periodSeconds: 5
          resources:
            requests:
              cpu: 100m
              memory: 256Mi
            limits:
              cpu: 500m
              memory: 1Gi
          volumeMounts:
            - mountPath: /etc/otel-collector-config.yaml
              name: otel-collector-config
              subPath: otel-collector-config.yaml
      volumes:
        - name: otel-collector-config
          configMap:
            name: otel-collector-config

