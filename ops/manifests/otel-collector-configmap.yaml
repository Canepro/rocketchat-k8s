apiVersion: v1
kind: ConfigMap
metadata:
  name: otel-collector-config
  namespace: monitoring
data:
  otel-collector-config.yaml: |
    extensions:
      health_check:
        endpoint: 0.0.0.0:13133
      pprof:
        endpoint: 0.0.0.0:1777
      zpages:
        endpoint: 0.0.0.0:55679
      # Basic Auth for OKE Tempo (credentials injected via env vars from Secret)
      basicauth/oke:
        client_auth:
          username: ${env:GRAFANA_USERNAME}
          password: ${env:GRAFANA_PASSWORD}

    receivers:
      otlp:
        protocols:
          grpc:
            endpoint: 0.0.0.0:4317
          http:
            endpoint: 0.0.0.0:4318
      jaeger:
        protocols:
          grpc:
            endpoint: 0.0.0.0:14250
          thrift_http:
            endpoint: 0.0.0.0:14268
          thrift_compact:
            endpoint: 0.0.0.0:6831
          thrift_binary:
            endpoint: 0.0.0.0:6832
      zipkin:
        endpoint: 0.0.0.0:9411

      # Scrape the collector's own Prometheus telemetry metrics
      prometheus:
        config:
          scrape_configs:
            - job_name: 'otel-collector'
              scrape_interval: 10s
              static_configs:
                - targets: ['localhost:8888']

    processors:
      batch:
        timeout: 1s
        send_batch_size: 1024
      memory_limiter:
        check_interval: 1s
        limit_mib: 512
      resource:
        attributes:
          - key: service.name
            value: rocket-chat
            action: upsert
          - key: service.version
            value: "1.0.0"
            action: upsert
          - key: deployment.environment
            value: production
            action: upsert
          # Add cluster identifier to all traces
          - key: cluster
            value: rocketchat-k3s
            action: upsert
          - key: region
            value: remote
            action: upsert

    exporters:
      logging:
        loglevel: info

      # OKE Central Hub Tempo (Secure HTTP)
      # Using OTLP/HTTP is more reliable through Ingress than gRPC
      otlphttp/oke:
        endpoint: https://observability.canepro.me/tempo
        auth:
          authenticator: basicauth/oke

      # Expose scraped collector metrics for optional scraping on 8889 (kept for compatibility)
      prometheus:
        endpoint: "0.0.0.0:8889"

    service:
      extensions: [health_check, pprof, zpages, basicauth/oke]
      # Expose detailed internal metrics so span counters appear (otelcol_*spans*)
      telemetry:
        metrics:
          address: 0.0.0.0:8888
          level: detailed
      pipelines:
        traces:
          receivers: [otlp, jaeger, zipkin]
          processors: [memory_limiter, batch, resource]
          exporters: [otlphttp/oke, logging]
        metrics:
          receivers: [prometheus]
          processors: [memory_limiter, batch]
          exporters: [prometheus, logging]

