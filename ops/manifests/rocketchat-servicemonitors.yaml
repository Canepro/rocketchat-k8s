# Rocket.Chat ServiceMonitors for Prometheus Scraping
# These ServiceMonitors configure Prometheus Agent to scrape metrics from Rocket.Chat services.
# ServiceMonitors are part of the Prometheus Operator CRD (Custom Resource Definition).
# Prometheus Agent uses these ServiceMonitors to discover and scrape metrics endpoints.
# See VERSIONS.md for Prometheus Operator version tracking (not directly deployed, used by Prometheus Agent).
---
# ServiceMonitor: Main Rocket.Chat application metrics
# Scrapes metrics from the main Rocket.Chat HTTP service (/metrics endpoint)
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: rocketchat-main  # ServiceMonitor name (referenced by Prometheus Agent)
  namespace: rocketchat  # Namespace for Rocket.Chat services
  labels:
    release: monitoring  # Label for Prometheus Agent to discover this ServiceMonitor
spec:
  selector:
    # Match services with these labels (from Rocket.Chat Helm chart)
    matchLabels:
      app.kubernetes.io/name: rocketchat  # Rocket.Chat application name
      app.kubernetes.io/instance: rocketchat  # Rocket.Chat instance name
  namespaceSelector:
    # Only scrape services in the rocketchat namespace
    matchNames:
      - rocketchat
  endpoints:
    # Metrics endpoint configuration
    - port: http  # Service port name (from Rocket.Chat service)
      interval: 30s  # Scrape interval (how often to collect metrics)
      path: /metrics  # Metrics path (Rocket.Chat exposes Prometheus metrics here)

---
# ServiceMonitor: Rocket.Chat microservices metrics
# Scrapes metrics from Rocket.Chat microservices (account, authorization, ddp-streamer, presence)
# These microservices expose metrics on port 9458 (different from main app)
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: rocketchat-microservices  # ServiceMonitor name (referenced by Prometheus Agent)
  namespace: rocketchat  # Namespace for Rocket.Chat microservices
  labels:
    release: monitoring  # Label for Prometheus Agent to discover this ServiceMonitor
spec:
  selector:
    # Match services with these labels (from Rocket.Chat microservices)
    matchLabels:
      app.kubernetes.io/name: rocketchat  # Rocket.Chat application name
      app.kubernetes.io/instance: rocketchat  # Rocket.Chat instance name
  namespaceSelector:
    # Only scrape services in the rocketchat namespace
    matchNames:
      - rocketchat
  endpoints:
    # Metrics endpoint configuration
    - port: "9458"  # Microservices metrics port (different from main app port 8080)
      interval: 30s  # Scrape interval (how often to collect metrics)
      path: /metrics  # Metrics path (microservices expose Prometheus metrics here)

---
# ServiceMonitor: MongoDB metrics
# Scrapes metrics from MongoDB Community Operator's metrics service
# MongoDB exposes Prometheus metrics on port 9216 via a metrics sidecar
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: rocketchat-mongodb  # ServiceMonitor name (referenced by Prometheus Agent)
  namespace: rocketchat  # Namespace for MongoDB
  labels:
    release: monitoring  # Label for Prometheus Agent to discover this ServiceMonitor
spec:
  selector:
    # Match services with these labels (from MongoDB Community Operator)
    matchLabels:
      app.kubernetes.io/name: mongodb  # MongoDB application name
      app.kubernetes.io/component: metrics  # Metrics component (not main database)
      app.kubernetes.io/instance: rocketchat  # MongoDB instance name
  namespaceSelector:
    # Only scrape services in the rocketchat namespace
    matchNames:
      - rocketchat
  endpoints:
    # Metrics endpoint configuration
    - port: "9216"  # MongoDB metrics port (from MongoDB Community Operator metrics service)
      interval: 30s  # Scrape interval (how often to collect metrics)
      path: /metrics  # Metrics path (MongoDB exposes Prometheus metrics here)

---
# ServiceMonitor: NATS metrics
# Scrapes metrics from NATS server's monitoring service
# NATS exposes Prometheus metrics on port 8222 (HTTP monitoring port)
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: rocketchat-nats  # ServiceMonitor name (referenced by Prometheus Agent)
  namespace: rocketchat  # Namespace for NATS
  labels:
    release: monitoring  # Label for Prometheus Agent to discover this ServiceMonitor
spec:
  selector:
    # Match services with these labels (from NATS StatefulSet)
    matchLabels:
      app.kubernetes.io/name: nats  # NATS application name
      app.kubernetes.io/instance: rocketchat  # NATS instance name
  namespaceSelector:
    # Only scrape services in the rocketchat namespace
    matchNames:
      - rocketchat
  endpoints:
    # Metrics endpoint configuration
    - port: "8222"  # NATS monitoring port (HTTP endpoint for Prometheus scraping)
      interval: 30s  # Scrape interval (how often to collect metrics)
      path: /metrics  # Metrics path (NATS exposes Prometheus metrics here via prometheus-nats-exporter)

